/**
 * @author Malte Reißig <malte.reissig@tu-berlin.de>
 * @website https://github.com/mukil/org.deepamehta-tagging-resources
 * @license GPL Version 3.0
 * @version 0.2.4-SNAPSHOT
 */(function(a,b,c,d,e){var f=this;f.model=AppModel(),f.dict=new EduzenDictionary("DE"),f.dmc=e,f.emc=new EMC(e,f.model),f.piwikTracker=typeof piwikTracker!="undefined"?piwikTracker:undefined;var g=undefined,h="",i="dm4.tags.tag",j="org.deepamehta.reviews.score",k="org.deepamehta.resources.created_at",l="org.deepamehta.resources.last_modified_at",m="org.deepamehta.resources.resource",n="org.deepamehta.resources.content",o="org.deepamehta.resources.blocked_for_edits",p="org.deepamehta.moodle.item_modified",q="org.deepamehta.moodle.item",r=15,s=200,t="message-top",u="message-timeline",v="personal-timeline",w="filtered-timeline",x="timeline",y="detail-view",z="input.tagging";this.prepare_detail_page=function(a){h=y,f.emc.loadResourceById(a),f.render_toolbar(),f.prepare_detail_view(),f.render_detail_view(),f.hide_progress_bar(),f.show_detail_elements()},this.prepare_index_page=function(a,b){a&&f.show_progress_bar(),f.load_resources(),f.sort_available_resources(),f.setup_timeline_controls(!1),f.render_toolbar(),c(".eduzen .rendered #nav.info").show(),f.render_tag_filter_info(),f.render_tag_items("div.sidebar"),f.render_tag_header(),f.render_result_view(!1),b&&f.hide_progress_bar(),f.show_timeline_elements()},this.prepare_profile_page=function(a,b,d){h=v,b&&f.show_progress_bar(),f.model.setTagFilter([]),f.setup_timeline_controls(!0);var e=f.emc.getTopicById(a.id);g=new User(f,f.dict,f.emc,e),g.setupView(c("#profile")),f.load_contributions(e.id),f.sort_contributed_resources(),f.render_toolbar(),f.render_tag_filter_info(),f.render_result_view(!0),d&&f.hide_progress_bar(),f.show_timeline_elements(!0)},this.prepare_profile_editor_view=function(a){c("#resources .list").empty();var b=f.emc.getTopicById(a.id);g=new User(f,f.dict,f.emc,b),g.setupView(c("#profile"));var d=c("#profile");g.renderSettingsEditor(d),g.renderAccountEditor(d)},this.prepare_detail_view=function(){function l(){function d(){var b=getTeXAndHTMLSource(document.getElementById("resource_input"));c("#resource_input").attr("contenteditable",!0),a.instances.hasOwnProperty("resource_input")?a.instances.resource_input.setData(b):c("#resource_input").html(b);if(g===f.emc.getCurrentUser()){var d=c("input.lock");d.attr("checked",h),d.show(),c("label.lock").show()}quickfixPDFImageRendering(),setTimeout(function(){process_math_in_area("resource_input",!0)},500)}a.instances.hasOwnProperty("resource_input")&&a.instances.resource_input.destroy(),f.setup_ckeditor("resource_input"),d();var b=c("input.submit.btn");b.unbind("click"),b.val("Änderungen speichern"),b.click(f.doSaveResource)}var b=f.getRelatedUserAccount(f.model.getCurrentResource().id),e=b.value;b.composite.hasOwnProperty("org.deepamehta.identity.display_name")&&(e=b.composite["org.deepamehta.identity.display_name"].value);var g=b==null?"Anonymous":e,h=!1;f.model.getCurrentResource().composite.hasOwnProperty(o)?h=f.model.getCurrentResource().composite[o].value:h=!1;var i=checkLoggedInUser(),j=c("input.submit.btn");if(i!==null){var k=g===i?!0:!1;k||!h?(j.show(),j.unbind("click"),j.val("Inhalt ändern"),j.click(l)):(d.warn("You cannot edit this resource because it was set to be not editable by its creator"),j.hide())}else j.hide();c("input.lock").hide(),c("label.lock").hide()},this.render_detail_view=function(){var a=c("#resource_input");a.attr("contenteditable",!1),a.html(f.model.getCurrentResource().composite[n].value),c("a.print-view").attr("href","/notes/"+f.model.getCurrentResource().id+"/print");var b=f.getAccountTopic(f.model.getCurrentResource()),d=b.value;b.composite.hasOwnProperty("org.deepamehta.identity.display_name")&&(d=b.composite["org.deepamehta.identity.display_name"].value);var e=b==null?"Anonymous":d,g=c('<a title="Gehe zur Timeline von  '+e+'" class="btn link">'+e+"</a>");g.click(function(a){f.prepare_profile_page(b,!0,!0),f.pushPersonalViewState(b)});var h=f.emc.getAllContributor(f.model.getCurrentResource().id);if(h!=null){c("b.contributor.label").text("Mitwirkende:");var j=c("span.contributor");j.empty();for(var m in h){var o=h[m],p=c('<a id="'+o.id+'" title="Besuche '+o.value+'s Timeline" '+'class="btn link">'+o.value+"</a>").append("&nbsp;");p.click(function(a){var b=a.target.id,c=f.emc.getTopicById(b);f.prepare_profile_page(c,!0,!0),f.pushPersonalViewState(c)}),j.append(p)}}var q=new Date(f.model.getCurrentResource().composite[k].value),r=new Date(f.model.getCurrentResource().composite[l].value);q&&c("b.header-title").text(q.getDate()+"."+dict.monthNames[q.getMonth()]+" "+q.getFullYear()),g&&c(".content-area .creator").html(g),r&&c("b.header-title").append(', <b class="label">zuletzt bearbeitet am</b> '+r.getDate()+"."+dict.monthNames[r.getMonth()]+" "+r.getFullYear());var s=f.model.getCurrentResource().composite[i];c("#tags").empty();if(s!=undefined)for(var t=0;t<s.length;t++){var u=s[t];c("#tags").append('<a class="btn tag" title="Browse all notes tagged with '+u.value+'" '+'href="http://'+document.location.host+"/notes/tagged/"+u.value+'">'+u.value+"</a>&nbsp;")}process_math_in_area("resource_input",!1),quickfixPDFImageRendering()},this.render_result_view=function(a){c("#list-message").html('<br/><br/><b class="label">Calculating results</b>');var b=f.model.getAvailableResources();a&&(b=f.model.getProfileResources());if(b.length>0){c("#list-message").html("");var d=c("#resources .list");f.is_logged_in()?(d.html(f.create_input_item_view()),setup_ckeditor("add_resource"),setup_tag_completion(z),c(".eduzen #input input.submit").bind("click",f.doSubmitResource)):d.empty(),c.each(b,function(a,b){var c=f.create_result_item_view(b);d.append(c)}),process_math_in_area("resources"),quickfixPDFImageRendering(),f.render_load_more_button()}else c("#list-message").html('<br/><br/><b class="label">No posts to show.</b>'),c(".result-text").text("")},this.render_load_more_button=function(){if(h==x){var a=undefined;c(".list .load-more").length==0&&(a=c('<input type="button" class="load-more" value="Ältere Notizen ..." />'),a.click(function(a){f.append_page_to_result_view()}),c("#resources .list").append(a))}},f.append_page_to_result_view=function(){c(".list .load-more").remove(),f.model.page_nr=f.model.page_nr+1;var a=f.model.page_nr*r;d.log("Appending page "+f.model.page_nr+" to current result_set, offset is "+a),f.show_progress_bar();var b=f.emc.loadSomeResources(r,a,!0);f.add_to_resultlist_view(b),f.hide_progress_bar()},this.render_toolbar=function(){f.render_user_info();if(h==y||h==v){var a=undefined;a=c('<a class="home-menu-button btn" title="Zur&uuml;ck zur Timeline-Ansicht">Timeline</a>'),a.click(function(a){f.prepare_index_page(!0,!0),f.push_timeline_view_state()}),c("#menu").append(a)}else c("#menu .home-menu-button").remove()},this.render_tag_filter_info=function(){var a=f.model.getTagFilter();if(a.length==0)return c(".tag-filter-info").empty(),undefined;c("div.login-menu").hide(),c("a.login-menu-button").removeClass("pressed");var b=f.model.getAvailableResources().length,d="";b>1?d="<b>"+b+"</b> Beitr&auml;ge getagged mit":d="<b>"+b+"</b> Beitrag getagged mit";var e=c('<span class="meta">'+d+"</span>"),g=c('<span class="buttons"></span>');for(var h=0;h<a.length;h++){var i=c('<a id="'+a[h].id+'" class="close" title="Tag aus dem Filter entfernen">x</a>');i.click(function(a){var b=parseInt(a.target.id),c=f.model.getTagById(b);f.model.removeTagFromFilter(c),f.model.getTagFilter().length==0&&f.model.setAvailableResources([]),f.prepare_index_page(!0,!0),f.push_timeline_view_state()});var j=c('<a class="btn tag selected">'+a[h].value+"</a>");j.append(i),g.append(j)}var k=c('<a class="reset btn" title="Alle Tags aus dem Filter entfernen">').html("Filter zur&uuml;cksetzen");return k.click(function(a){f.model.setTagFilter([]),f.model.setAvailableResources([]),f.prepare_index_page(!0,!0),f.push_timeline_view_state()}),c(".tag-filter-info").html(e).append(k).append(g),null},this.render_tag_header=function(){var a="Filter Beitr&auml;ge nach Tags&nbsp;",b=c("<input>").addClass("tag-input-filter");b.attr("placeholder","..."),c(".tag-cloud-header").html(a).append("<br/><br/>").append(b),f.setup_tag_completion("input.tag-input-filter",function(a){var b=f.get_entered_tags("input.tag-input-filter");for(var c=0;c<b.length;c++){var d=f.model.getTagByName(b[c]);typeof d!="undefined"&&f.model.addTagToFilter(d),f.prepare_index_page(!0,!0),f.push_timeline_view_state()}})},this.render_tag_items=function(a){var b=undefined;f.model.getTagFilter().length==0?b=f.model.getAvailableTags():(b=getAllTagsInCurrentResults(),b=sliceAboutFilteredTags(b)),b.sort(f.name_sort_asc);if(b.length>0){var d=undefined;c(a+" .info div.tag-list").length==0?(d=c('<div class="tag-list">'),c(a+" .info").append(d)):(c(a+" .info div.tag-list a").remove(),d=c(a+" .info div.tag-list")),c(a+" .info div.tag-list").show(),render_tag_buttons(d,b)}else c(a+" .info div.tag-list a").remove(),c(a+" .info div.tag-list").hide()},this.render_tag_buttons=function(a,b){if(b==undefined)return undefined;for(var d=0;d<b.length;d++){var e=b[d],g=c('<a id="'+e.id+'" class="btn tag" title="Filter Timeline nach '+e.value+'">'+e.value+"</a>");g.click(function(a){var b=a.target.id;c("a#"+b).remove();var d=f.model.getTagById(b);f.model.addTagToFilter(d),f.prepare_index_page(!0,!0),f.push_timeline_view_state()}),a.append(g)}return null},this.render_current_view=function(){if(h==y)f.prepare_detail_page(f.model.getCurrentResource().id);else if(h==v){var a=f.emc.getTopicById(f.model.getProfileResourcesId());f.prepare_profile_page(a)}else(h==w||h==x)&&f.prepare_index_page(!1,!1)},this.show_timeline_elements=function(a){c("div.content-area").hide(),c("div#resources").show(),c("div.sidebar").show(),c("body.eduzen").removeClass("note"),a?(c("body.eduzen").addClass("personal"),c("div#profile").show(),c(".eduzen #nav.info").hide()):(c("body.eduzen").removeClass("personal"),c("div#profile").hide(),c(".eduzen #nav.info").show())},this.show_detail_elements=function(){c("body.eduzen").addClass("note"),c("body.eduzen").removeClass("personal"),c("div#resources").hide(),c("div.sidebar").hide(),c("div#profile").hide(),c(".eduzen #nav.info").hide(),c("div.content-area").show()},this.show_progress_bar=function(){var a=c("#progressbar").progressbar("widget");a.progressbar("enable"),a.show(),a.progressbar({value:10,max:100})},this.hide_progress_bar=function(){var a=c("#progressbar");a.progressbar({value:100}),a.progressbar("disable"),a.hide()},this.create_login_view=function(){function h(a,b){function d(){return"Basic "+btoa(a+":"+b)}a===undefined&&b===undefined&&(a=c("input.username-input").val(),b=c("input.secret").val());var d=d(),e=null;if(d===undefined)return null;c.ajax({type:"POST",url:"/accesscontrol/login",headers:{Authorization:d},async:!1}).done(function(a){f.render_current_view(),e=f.checkLoggedInUser()}).fail(function(a){c("div.login-menu .message").addClass("failed"),c("div.login-menu .message").text("Nutzername oder Passwort ist falsch."),e=null}).always(function(a){return e})}c("div.login-menu").remove(),c("a.login-menu-button").remove();var a=c('<div class="login-menu">'),b=c('<input type="text" placeholder="Username">');b.addClass("username-input");var d=c('<input type="password" placeholder="Password">');d.addClass("secret"),d.keyup(function(a){return a.keyCode===c.ui.keyCode.ENTER&&h(),function(a){}});var e=c('<input type="button" class="btn login" value="Login">');e.click(h);var g=c('<a class="login-menu-button btn" href="#login">Login</a>');g.click(function(a){c("div.login-menu").toggle(),g.toggleClass("pressed")}),a.append(b).append(d).append(e).append('<span class="message"><a href="http://www.eduzen.tu-berlin.de/zur-notizen-webanwendung#account">Account?</a></span>'),g.insertBefore("div.pages"),a.insertBefore("div.pages"),c(".about-login").html("Um Beitr&auml;ge zu verfassen musst du eingeloggt sein.</div>")},this.load_resources=function(){if(f.model.getTagFilter().length>1)f.emc.loadAllResourcesByTags({tags:f.model.getTagFilter()}),h=w;else if(f.model.getTagFilter().length==1){var a=f.model.getTagFilter()[0];f.emc.loadAllResourcesByTagId(a.id),h=w}else f.model.getAvailableResources().length<=1&&f.emc.loadSomeResources(r,0,!1),h=x},this.load_contributions=function(a){(f.model.getProfileResources().length==0||f.model.getProfileResourcesId()!=a)&&f.emc.loadAllContributions(a)},this.sort_available_resources=function(){f.model.isSortedByScore?f.model.getAvailableResources().sort(f.score_sort_asc):f.model.getAvailableResources().sort(f.created_at_sort_asc)},this.sort_contributed_resources=function(){f.model.isSortedByScore?f.model.getProfileResources().sort(f.score_sort_asc):f.model.getProfileResources().sort(f.created_at_sort_asc)},this.sort_current_tags=function(){f.model.getAvailableTags().sort(f.name_sort_asc)},this.checkLoggedInUser=function(){var a=f.emc.getCurrentUser();return a!==""?a:null},this.is_logged_in=function(){var a=f.emc.getCurrentUser();return a!==""?!0:!1},this.setDefaultWorkspaceCookie=function(){var a=e.get_topic_by_value("uri","de.workspaces.deepamehta");js.set_cookie("dm4_workspace_id",a.id)},this.getLoggedInUserTopic=function(){return f.emc.getCurrentUserTopic()},this.render_user_info=function(){var a=c(".username");if(!f.is_logged_in())a.text("Willkommen"),c("li#input div.header").hide(),c(".log-in-message").show(),c(".eduzen.notes").addClass("guest"),c(".eduzen .content-area input.submit.btn").unbind("click"),f.create_login_view();else{c(".eduzen.notes").removeClass("guest"),c(".log-in-message").hide(),c("div.login-menu").hide(),c("a.login-menu-button").hide(),c("li#input div.header").show();var b=f.emc.getCurrentUserTopic(),d=c('<a class="btn my" title="Zeige meine Beitr&auml;ge">'+b.value+"</a>");d.click(function(a){f.prepare_profile_page(b,!0,!0),f.pushPersonalViewState(b)}),a.html("Hi").append(d);var e=c('<a class="btn logout" title="Session beenden">Logout</a>');e.click(function(a){f.emc.logout()&&c("body").html('<div class="logout-message">You\'re logged out now.<br/><br/><a href="/">Reload Application</a></div>')}),a.append(e)}},this.setup_tag_completion=function(a,b){function d(a){return a.split(/,\s*/)}function e(a){return d(a).pop()}c(a).bind("keydown",function(a){a.keyCode===c.ui.keyCode.TAB&&c(this).data("ui-autocomplete").menu.active?a.preventDefault():a.keyCode!==c.ui.keyCode.ENTER}).autocomplete({minLength:0,source:function(a,b){b(c.ui.autocomplete.filter(f.model.getAvailableTags(),e(a.term)))},focus:function(){return!1},select:function(a,c){var e=d(this.value);return e.pop(),e.push(c.item.value),e.push(""),this.value=e.join(", "),typeof b!="undefined"&&b(),!1}})},this.setup_timeline_controls=function(a){c(".onoffswitch-label").unbind("click"),c(".onoffswitch-label").click(function(b){f.model.isSortedByScore?(a?f.model.setProfileResources(getAlphabeticalContributions()):f.model.setAvailableResources(getAlphabeticalAvailable()),f.model.isSortedByScore=!1):(a?f.model.setProfileResources(getHighestContributions()):f.model.setAvailableResources(getHighestAvailable()),f.model.isSortedByScore=!0),f.render_result_view(a)})},this.add_to_resultlist_view=function(a){var b=c("#resources .list");c.each(a,function(a,c){var d=f.create_result_item_view(c);b.append(d)}),f.render_load_more_button(),process_math_in_area("resources"),quickfixPDFImageRendering()},this.create_input_item_view=function(){return'<li id="input"><div class="header"><span class="header-title label">Neuen Beitrag verfassen<a class="help">*</a></span><br/><br/><div class="help info">Du kannst mithilfe unseres Editors Beitr&auml;ge in Form von HTML verfassen. Unser Editor erm&ouml;glicht dir momentan <b>Mathe-Formeln</b>, <b>Bilder</b>, <b>Web-Videos</b> und <b>Web-Sound</b> in HTML einzubetten.<br/>Hier eine kleine Illustration die euch diese 4 Funktionen im Editor-Bereich zeigt.<br/><img src="/org.deepamehta.eduzen-tagging-notes/images/cK_Editor_help_01.png" /><br/>Aktuell ist es erstmals experimentell m&ouml;glich <b>&uuml;ber den Bild-Dialog auch PDF-Dokumente hochzuladen und einzubetten</b>.<br/>Wir wollen diesen Editor-Bereich st&auml;ndig weiter verbessern, ein robusteres PDF-Feature wollen wir dabei mit als n&auml;chstes angehen.<br/><br/><br/></div><div class="input-area"><div id="add_resource" contenteditable="false"></div><br/><span class="header-title label">Tags hinzuf&uuml;gen</span><br/><input type="text" placeholder="..." class="tagging" title="Notiz verschlagworten"></input><input type="button" class="submit" value="Hinzuf&uuml;gen" title="Notiz speichern"/></div></div></li>'},this.create_result_item_view=function(a){var b=c("li#"+a.id);return a.type_uri==m?(new NoteItemRenderer(a,f)).render(b):a.type_uri==q?(new MoodleItemRenderer(a,f)).render(b):""},this.quickfixPDFImageRendering=function(){c.each(c("img"),function(a,b){b.src.toLowerCase().indexOf(".pdf")!=-1&&(c('<object data="'+b.src+'" width="760" height="640" type="application/pdf">').insertAfter(b),typeof b.remove=="function"&&b.remove())})},this.setup_ckeditor=function(b){a.instances.hasOwnProperty(b)&&a.instances[b].destroy(),c(".header a.help").click(function(a){c(".header .help.info").toggle(),c(".header .help.info").click(function(a){c(".header .help.info").toggle()})});var d=c("#"+b);d.attr("contenteditable",!0),a.instances.hasOwnProperty(b)||(a.inline(document.getElementById(b)),a.instances[b].selectionChange=function(){f.process_math_in_area(b,!0)}),a.app_model=f.model},this.setupMathJaxRenderer=function(){b.Ajax.config.root="/de.tu-berlin.eduzen.mathjax-renderer/script/vendor/mathjax",b.Hub.Config({extensions:["tex2jax.js","mml2jax.js","MathEvents.js","MathZoom.js","MathMenu.js","toMathML.js","TeX/noErrors.js","TeX/noUndefined.js","TeX/AMSmath.js","TeX/AMSsymbols.js","FontWarnings.js"],jax:["input/TeX","output/HTML-CSS"],tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]]},menuSettings:{mpContext:!0,mpMouse:!0,zscale:"200%",texHints:!0},errorSettings:{message:["[Math Error]"]},displayAlign:"left","HTML-CSS":{scale:110},"v1.0-compatible":!1,skipStartupTypeset:!1,elements:["resource_input, add_resource, math-live-preview, resources"]}),b.Hub.Register.StartupHook("TeX Jax Ready",function(){f.notify_browser("Die Mathe-TeX Umgebung wurde soeben geladen und kann jetzt benutzt werden.",s)}),b.Hub.Configured(),b.Hub.Typeset()},this.process_math_in_area=function(d,e){b.Hub.Queue(["Typeset",b.Hub,d]),e&&(c("div.math-output").unbind("click"),c("div.math-output").unbind("dblclick"),c("div.math-output").click(function(b){var e=f.model.getSelectedFormula();f.model.getSelectedFormula()!=undefined&&f.deselectEditableFormula(e),c(e).attr("data-tex")!==c(this).attr("data-tex")&&f.selectEditableFormula(this),a.instances[d].selectionChange()}),c("div.math-output").dblclick(function(b){f.selectEditableFormula(this),a.instances[d].openDialog("mathjaxDialog")}))},this.deselectEditableFormula=function(a){c(a).removeClass("selected"),f.model.setSelectedFormula(undefined)},this.selectEditableFormula=function(a){f.model.setSelectedFormula(a),c(a).addClass("selected")},this.notify_browser=function(a,b,c,e,f,g){b==s?d.log(a):d.warn(a)},this.getHighestAvailable=function(){var a=f.model.getAvailableResources();return a.sort(score_sort_asc)},this.getAlphabeticalAvailable=function(){var a=f.model.getAvailableResources();return a.sort(created_at_sort_asc)},this.getHighestContributions=function(){var a=f.model.getProfileResources();return a.sort(score_sort_asc)},this.getAlphabeticalContributions=function(){var a=f.model.getProfileResources();return a.sort(created_at_sort_asc)},this.getAllTagsInCurrentResults=function(){var a=[],b=f.model.getAvailableResources();for(var c=0;c<b.length;c++){var d=b[c];if(d.composite.hasOwnProperty(i)&&d.composite[i]!=undefined){var e=d.composite[i];for(var g=0;g<e.length;g++){var h=e[g];addUniqueTagToTagFilter(h,a)}}}return a},this.addUniqueTagToTagFilter=function(a,b){var c=!0;for(var d=0;d<b.length;d++)b[d].id==a.id&&(c=!1);c&&b.push(a)},this.sliceAboutFilteredTags=function(a){var b=f.model.getTagFilter(),c=[];for(var d=0;d<a.length;d++){var e=!0;for(var g=0;g<b.length;g++){var h=b[g];a[d].id==h.id&&(e=!1)}e&&c.push(a[d])}return c},this.registerHistoryStates=function(){window.history&&window.addEventListener("popstate",f.popHistory)},this.popHistory=function(a){if(a.state!=null)if(a.state.name==w)f.model.setTagFilter(a.state.data.tags),f.prepare_index_page(!0,!0);else if(a.state.name==x)f.model.setTagFilter([]),f.prepare_index_page(!0,!0);else if(a.state.name==v){var b=a.state.data.userid,c=e.get_topic_by_id(b,!0);f.model.setTagFilter([]),f.prepare_profile_page(c,!0,!0)}else a.state.name==y?f.prepare_detail_page(a.state.data.id):(d.log("unknown view.. "),d.log(a))},this.push_timeline_view_state=function(){var a=undefined;f.model.getTagFilter().length>0?(a={name:w,data:{tags:f.model.getTagFilter(),userid:0}},f.pushHistory(a,"Tagged Timeline","/notes/tagged/"+f.model.getTagFilterURI())):(a={name:x,data:{tags:[],userid:0}},f.pushHistory(a,"Notizen Timeline","/notes/"))},this.pushPersonalViewState=function(a){var b={name:v,data:{tags:f.model.getTagFilter(),userid:a.id}};f.pushHistory(b,"Personal Timeline","/notes/user/"+a.id)},this.pushDetailViewState=function(a){var b={name:y,data:a};f.pushHistory(b,"Note Detail View","/notes/"+a.id)},this.pushHistory=function(a,b,c){if(!window.history)return;var d={state:a,name:b,url:c};window.history.pushState(d.state,b,d.url)},this.score_sort_asc=function(a,b){var c=0,d=0;return a.composite.hasOwnProperty(j)&&(c=a.composite[j].value),b.composite.hasOwnProperty(j)&&(d=b.composite[j].value),c>d?-1:c<d?1:0},this.created_at_sort_asc=function(a,b){var c=0,d=0;return a.composite.hasOwnProperty(p)&&(c=a.composite[p].value),b.composite.hasOwnProperty(p)&&(d=b.composite[p].value),a.composite.hasOwnProperty(k)&&(c=a.composite[k].value),b.composite.hasOwnProperty(k)&&(d=b.composite[k].value),c>d?-1:c<d?1:0},this.name_sort_asc=function(a,b){var c=a.value,d=b.value;return c.toLowerCase()>d.toLowerCase()?1:c.toLowerCase()<d.toLowerCase()?-1:0},this.getRelatedUserAccount=function(a){var b=f.emc.getFirstRelatedCreator(a);return b=f.emc.getTopicById(b.id),b},this.getAccountTopic=function(a){return a.composite.hasOwnProperty("dm4.accesscontrol.user_account")?a.composite["dm4.accesscontrol.user_account"]:null},this.get_entered_tags=function(a){if(c(a).val()==undefined)return undefined;var b=c(a).val().split(/,\s*/);if(b==undefined)throw new Error("Tagging field got somehow broken.. ");var d=[];for(var e=0;e<b.length;e++){var f=b[e];if(f.match(/\S/)!=null){var g=!0;for(var h=0;h<d.length;h++){var i=d[h];i.toLowerCase()===f.toLowerCase()&&(g=!1)}g&&d.push(f)}}return d},this.getTagTopicsToReference=function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c];for(var e=0;e<f.model.getAvailableTags().length;e++){var g=f.model.getAvailableTags()[e];g.value.toLowerCase()===d.toLowerCase()&&b.push(g)}}return b},this.getTagTopicsToCreate=function(a,b){var c=[];if(b==undefined)return a;for(var d=0;d<a.length;d++){var e=a[d],f=!0;for(var g=0;g<b.length;g++){var h=b[g];e.toLowerCase()===h.value.toLowerCase()&&(f=!1)}f&&c.push(e)}return c},this.getTeXAndHTMLSource=function(a){var e=c(".math-output",a),f="";for(var g=0;g<e.length;g++){var h=e[g],i=h.getAttribute("data-tex");i?h.innerHTML='<div class="math-preview">$$ '+i+" $$</div>":d.log("ERROR: MathJaxSourceNotFound for container => "+containerId+" and "+containerId)}return f=a.innerHTML,b.Hub.Typeset(),f},this.doSubmitResource=function(){var a=getTeXAndHTMLSource(document.getElementById("add_resource")),b=get_entered_tags(z),e=getTagTopicsToReference(b),g=getTagTopicsToCreate(b,e),h=undefined;if(a.match(/\S/)!=null&&a!=="<p><br></p>"){h=f.emc.createResourceTopic(a,g);if(h!=undefined){for(var i=0;i<e.length;i++)if(e[i]!=undefined){var j=f.emc.createResourceTagAssociation(h,e[i]);j||d.warn("We could not create a Resource <-> Tag association ..")}typeof piwikTracker!="undefined"&&piwikTracker.trackGoal(5),c("#add_resource").html(""),c(z).val(""),c("div.header").css("opacity","1")}}else f.notify_browser("Wir werden nur unfreiwillig inhaltsfreie Beitr&auml;ge speichern.",400,u,"","slow");f.prepare_index_page(!1)},this.doSaveResource=function(){var b=f.model.getSelectedFormula();f.model.getSelectedFormula()!=undefined&&f.deselectEditableFormula(b);var d=getTeXAndHTMLSource(document.getElementById("resource_input")),e=c("input.lock").attr("checked")==="checked"?!0:!1;if(d.match(/\S/)!=null&&d!=="<p><br></p>"){var g=f.model.getCurrentResource();g.composite[n].value=d,g.composite[o]={value:e,type_uri:o,uri:""};var h=f.emc.updateResourceTopic(g);h!=undefined?(typeof piwikTracker!="undefined"&&piwikTracker.trackGoal(1),f.model.updateAvailableResource(g),a.instances.hasOwnProperty("resource_input")&&a.instances.resource_input.destroy(),f.prepare_detail_page(h.id)):f.notify_browser("Sorry! Wir konnten die Notiz nicht aktualisieren.",500,t,"","fast")}else f.notify_browser("Wir werden nur unfreiwillig inhaltsfreie Postings speichern.",400,t,"","slow")},this.page_route=function(){var a=window.location.pathname,b=a.split("/"),d=b[2];f.registerHistoryStates(),f.setupMathJaxRenderer(),f.setDefaultWorkspaceCookie(),f.emc.loadAllTags(),f.sort_current_tags();if(d===undefined||d==="")f.prepare_index_page(!0,!1),c(window).on("load",function(a){f.hide_progress_bar()});else if(d==="tagged"){var g=b[3];g=g.indexOf("+")!=-1?g.split("+"):g.split("%2B");var h=undefined;for(var i=0;i<g.length;i++){var j=decodeURIComponent(g[i]);h=f.model.getTagByName(j),h!=undefined&&f.model.addTagToFilter(h)}f.prepare_index_page(!0,!1),c(window).on("load",function(a){f.hide_progress_bar()})}else if(d==="user"){var k=b[3],l=e.get_topic_by_id(k,!0);f.prepare_profile_page(l,!0,!1),c(window).on("load",function(a){f.hide_progress_bar()})}else f.prepare_detail_page(d)}})(CKEDITOR,MathJax,jQuery,console,new RESTClient("/core"));