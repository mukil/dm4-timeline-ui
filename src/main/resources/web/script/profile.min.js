/**
 * @author Malte Reißig <malte.reissig@tu-berlin.de>
 * @website https://github.com/mukil/org.deepamehta-tagging-resources
 * @license GPL Version 3.0
 * @version 0.2.4-SNAPSHOT
 */function User(a,b,c,d){var e=this;e.ui=undefined;var f={account:d},g="org.deepamehta.identity.profile_picture_edge";this.setupView=function(a){e.ui=new GUIToolkit;var b=$('<div class="profile">');b.append('<div class="view"></div>'),b.append('<div class="settings"></div>'),a.html(b);if(f.account!=null){var d=f.account.value===c.getCurrentUser()?!0:!1,g=$(".profile .view");e.renderDisplayName(g,d),e.renderProfileData(g)}else f.account=c.getCurrentUserTopic()},this.renderDisplayName=function(b,d){if(typeof f.account=="undefined")return undefined;var e=f.account.composite,h=e.hasOwnProperty("org.deepamehta.identity.display_name")?e["org.deepamehta.identity.display_name"].value:f.account.value,i=$('<div class="display-name">'),j=c.getFirstRelatedTopic(f.account.id,g,"dm4.files.file");if(j!=null){var k="/filerepo/profile-pictures/"+j.value,l=$('<img src="'+k+'" title="Profile picture" class="profile-picture">');i.append(l)}i.append('<span class="name">'+h+"</span>");var m=e.hasOwnProperty("org.deepamehta.identity.subject_of_study")?e["org.deepamehta.identity.subject_of_study"].value:"",n=$('<span class="subject-of-study">');n.append(m),m!==""&&i.append("<br/>").append(n),b.append("<br/>");if(d){var o=$('<a class="btn edit-profile">');o.text("Bearbeite dein Profil"),o.click(function(b){a.prepare_profile_editor_view(f.account)});var p=$('<span class="edit-area">');p.append(o),i.append(p)}b.html(i)},this.renderProfileData=function(a){if(typeof f.account=="undefined")return undefined;var b=f.account.composite,c=b.hasOwnProperty("org.deepamehta.identity.contact")?b["org.deepamehta.identity.contact"]:undefined,d=$('<div class="contact-entries">');typeof c!="undefined"&&d.append('<span class="label">Kontaktm&ouml;glichkeit</span><br/>');for(var e in c){var g=c[e],h=g.composite.hasOwnProperty("org.deepamehta.identity.contact_label")?g.composite["org.deepamehta.identity.contact_label"].value:"",i=g.composite.hasOwnProperty("org.deepamehta.identity.contact_entry")?g.composite["org.deepamehta.identity.contact_entry"].value:"";d.append('<span class="label">'+h+"</span>"),d.append('<span class="entry">'+i+"</span>"),d.append("<br/>")}a.append(d);var j=b.hasOwnProperty("org.deepamehta.identity.infos")?b["org.deepamehta.identity.infos"].value:"",k=$('<div class="infos">');k.text(j),a.append(k)},this.renderSettingsEditor=function(b){$("#profile .profile").hide(),$("#profile .user-settings").remove();var d=f.account.composite,h=d.hasOwnProperty("org.deepamehta.identity.display_name")?d["org.deepamehta.identity.display_name"].value:f.account.value,i=d.hasOwnProperty("org.deepamehta.identity.subject_of_study")?d["org.deepamehta.identity.subject_of_study"].value:"",j=d.hasOwnProperty("org.deepamehta.identity.contact")?d["org.deepamehta.identity.contact"][0].composite["org.deepamehta.identity.contact_label"]:{id:-1,value:"Skype"},k=d.hasOwnProperty("org.deepamehta.identity.contact")?d["org.deepamehta.identity.contact"][0].composite["org.deepamehta.identity.contact_entry"].value:"",l=d.hasOwnProperty("org.deepamehta.identity.contact")?d["org.deepamehta.identity.contact"][0].id:"-1",m=d.hasOwnProperty("org.deepamehta.identity.infos")?d["org.deepamehta.identity.infos"].value:"",n=$('<div class="user-settings">');n.append('<span class="label">Deine Profildaten</span><br/>'),n.append('<label for="display_name">Display Name</label>'),n.append('<input type="text" name="display_name" value="'+h+'"></input>'),n.append('<label for="display_name">Studienfach</label>'),n.append('<input type="text" name="subject_of_study" value="'+i+'"></input>'),n.append('<label for="contact_label">Kontaktm&ouml;glichkeit</label>'),n.append('<input id="'+j.id+'" type="text" name="contact_label" value="'+j.value+'" />'),n.append('<input id="'+l+'" type="text" name="contact_entry" value="'+k+'" />'),n.append('<label for="infos">Allgemeine Infos</label>'),n.append('<textarea name="infos" value="'+m+'">'+m+"</textarea>");var o=$('<input type="button" class="save-edits" value="Änderungen speichern">');o.click(function(b){e.doSaveUserProfile(),a.prepare_profile_page(f.account)}),n.append(o);var p=c.getFirstRelatedTopic(f.account.id,g,"dm4.files.file"),q=$('<div class="picture-area">');if(p!=null){var r="/filerepo/profile-pictures/"+p.value;q.append('<span class="picture label">Dein Profilbild</span>');var s=$('<img src="'+r+'" title="Profile picture" class="profile-picture editable">'),t=$('<img src="/org.deepamehta.eduzen-tagging-notes/images/remove_item.png" title="Remove current profile pricture" class="remove">');t.click(function(a){var d=c.getFirstAssociation(f.account.id,p.id,g);c.deleteAssociation(d.id),e.renderSettingsEditor(b);var h="<br/><br/><br/>Dein Profilbild wurde entfernt.";$("div.picture-area").append(h)}),q.append(s),q.append(t)}else{q.append('<label class"picture-label">Profile picture</label>');var u=$('<img src="/org.deepamehta.eduzen-tagging-notes/images/add_item.png" title="Add new profile pricture" class="add">');u.click(function(a){e.openUploadDialog("/profile-pictures",e.handleUploadResponse,b)}),q.append(u)}n.append(q),b.append(n),n.slideDown("slow")},this.renderAccountEditor=function(a){var b=f.account.value,c=f.account.composite["dm4.accesscontrol.password"].value,d='<br/><br/><span class="label">Deine Zugangsdaten</span><br/><form id="user-form" name="account" action="javascript:void(0)">  <label for="username">Username</label>  <input name="username" class="username" type="text" disabled="disabled" title="A username cannot be changed"    value="'+b+'" /><label for="pwdfield">Your password</label>'+'  <input name="pwdfield" class="pwdfield" type="password" disabled="disabled"'+'    placeholder="New password" value="'+c+'"></input>'+'  <input type="button" class="edit-pwd" value="Edit" />'+'  <input class="save-pwd" type="button" value="Speichern" />'+"</form>",g=$(".account-settings");g.length<=0&&(g=$('<div class="account-settings">')),g.html(d);var h='<br/><br/><span class="label">Dein ISIS Sicherheitsschl&uuml;ssel</span><br/><form id="moodle-key" name="moodle-key" action="javascript:void(0)">  <label for="security-key">(wird aus Sicherheitsgr&uuml;nden hier nicht angezeigt)</label>  <input name="security-key" class="security-key" type="password" value="" />  <input class="save-key" type="button" value="Neuen Key Speichern" />',i=$('<div class="moodle-settings">');i.html(h),$(".user-settings",a).append(g),$(".user-settings",a).append(i),$(".edit-pwd").click(e.editPasswordHandler),$(".save-pwd").click(e.submitPasswordHandler),$(".save-key").click(e.submitKeyHandler),$(".save-pwd").hide()},this.doSaveUserProfile=function(){var a=$("[name=display_name]").val(),b=$("[name=subject_of_study]").val(),d=$("[name=contact_entry]").attr("id"),e=$("[name=contact_label]").val(),g=$("[name=contact_entry]").val(),h=$("[name=infos]").val(),i=[];d!=-1?c.updateTopic({id:d,composite:{"org.deepamehta.identity.contact_label":e,"org.deepamehta.identity.contact_entry":g}}):g!==""&&(i=[{"org.deepamehta.identity.contact_label":e,"org.deepamehta.identity.contact_entry":g}]);var j={id:f.account.id,composite:{"org.deepamehta.identity.display_name":a,"org.deepamehta.identity.subject_of_study":b,"org.deepamehta.identity.contact":i,"org.deepamehta.identity.infos":h}};c.updateTopic(j)},this.openUploadDialog=function(a,b,c){function h(){g.close();var a=$("pre",window.frames["upload-target"].document).text();try{var d=JSON.parse(a);b(d,c)}catch(e){console.warn('Upload failed: "'+d+'"\nException='+JSON.stringify(e))}finally{$(".ui-dialog.ui-widget").hide()}}var d=$("<iframe>",{name:"upload-target"}).hide();$("body").append(d);var f=$("<form>",{method:"post",enctype:"multipart/form-data",target:"upload-target",action:"/files/"+a}).append($('<input type="file">').attr({name:"file",size:60})).append($('<input class="button" type="submit">').attr({value:"Upload"})).append($("<br/><br/><label>Hinweis: Dein Profilbild darf die Gr&ouml;&szlig;e von 180x180px nicht &uuml;berschreiten.</label>")),g=e.ui.dialog({id:"picture-upload",title:"Füge Profilbild hinzu",content:f});return $(".ui-dialog.ui-widget").show(),g.open(),d.unbind("load"),d.load(h),undefined},this.renderProfilePicture=function(a){var b=a;typeof b=="undefined"&&(b=c.getFirstRelatedTopic(f.account.id,g,"dm4.files.file"));if(b!=null){var d="/filerepo/profile-pictures/"+b.value;$("img.profile-picture editable").attr("src",d)}return b},this.handleUploadResponse=function(a,b){if(!a.hasOwnProperty("file_name"))throw new Error("FileUpload curiously failed.");c.createProfilePictureAssociation(f.account,a.topic_id),e.renderSettingsEditor(b);var d='<br/>Dein neues Profilbild "'+a.file_name+'" wurde '+"erfolgreich gespeichert.";$("div.picture-area").append(d)},this.editPasswordHandler=function(a,b,c){if($(".2nd.pwdfield")[0]==undefined)$(".pwdfield").removeAttr("disabled"),$(".pwdfield").val(""),$("[for=pwdfield]").html("New password"),$(".edit-pwd").hide(),$(".save-pwd").show(),e.renderAndPasswordField();else{$(".pwdfield").attr("disabled","disabled"),$(".pwdfield").attr("value",c),$(".2nd.pwdfield").remove(),$("[for=2ndpwdfield]").remove(),$(".save-pwd").hide(),$(".edit-pwd").show();var d=$('<span class="message ok">'+b+"</span>");$(d).insertAfter(".edit-pwd"),setTimeout(function(a){d.remove()},2500)}return void 0},this.renderAndPasswordField=function(){var a='<label for="2ndpwdfield">And again, please.</label><input name="2ndpwdfield" class="2nd pwdfield" type="password" placeholder="New password" value=""></input>';$(a).insertBefore(".save-pwd");var b=$('<input type="button" class="cancel-pwd" value="Abbrechen">');b.click(function(a){b.remove(),e.editPasswordHandler(undefined,"Your password remains unchanged.")}),$(b).insertAfter(".save-pwd")},this.submitPasswordHandler=function(a){var b=$(".pwdfield").val(),d=$(".2nd.pwdfield").val(),g=undefined,h="";$("input.cancel-pwd").remove(),b===d?(g="-SHA256-"+SHA256(b),f.account.composite["dm4.accesscontrol.password"].value=g,c.updateTopic(f.account.composite["dm4.accesscontrol.password"]),h="Your new password is now set."):h="Passwords did not match, your password remains unchanged.",e.editPasswordHandler(undefined,h,g)},this.submitKeyHandler=function(a){var b=$(".security-key").val();if(b!==""&&b!==" ")try{var d=c.setMoodleKey({moodle_key:b,user_id:f.account.id},f.account.id);d["result"]=="OK"&&($("#moodle-key").remove(),$(".moodle-settings").append('<br/><br/><span style="color:#00FF00;">Fine.</span><br/><br/>Your new ISIS Security key was saved.<br/><br/>All your ISIS courses (which we assigned a #hashtag) will be synchronized by your next login to Notizen.<br/><br/>'))}catch(g){$("#moodle-key").html('<span style="color:#FF0000;">Ups.</span><br/>Your input did not look like an ISIS Security Key.');var h=$('<br/><br/><span class="btn">Try again</span>');h.click(function(a){$("#moodle-key").empty(),e.renderAccountEditor($("#profile"))}),$("#moodle-key").append(h)}}};